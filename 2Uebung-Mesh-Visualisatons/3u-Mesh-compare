import pyvista as pv
import numpy as np

def load_and_process_mesh(filename):
    """Load mesh and prepare for analysis"""
    mesh = pv.read(filename)
    
    # Normalize stress values (scale to 0-1 range)
    stress = mesh['S_Mises']
    normalized = (stress - stress.min()) / (stress.max() - stress.min())
    mesh['normalized_stress'] = normalized
    
    return mesh

def find_differences(mesh1, mesh2, field='normalized_stress'):
    """Compare two meshes and find differences"""
    data1 = mesh1[field]
    data2 = mesh2[field]
    meshdiff= mesh1.copy()
    
    # Calculate difference
    diff = data1 - data2
    
    # Store in first mesh
    meshdiff['normalized_stress'] = diff
    
    return meshdiff

def visualize_comparison(original, modified):
    """Show original, modified, and difference side-by-side"""
    meshdiff = find_differences(original, modified)
    
    pl = pv.Plotter(shape=(1, 3))
    
    # Original
    pl.subplot(0, 0)
    pl.add_mesh(original, scalars='normalized_stress', cmap='coolwarm', scalar_bar_args={'title': 'Original Stress'}   )
    pl.add_text('Original', font_size=10)
    
    # Modified  
    pl.subplot(0, 1)
    pl.add_mesh(modified, scalars='normalized_stress', cmap='coolwarm', scalar_bar_args={'title': 'Modified Stress'})
    pl.add_text('Modified', font_size=10)
    
    # Difference
    pl.subplot(0, 2)
    pl.add_mesh(meshdiff, scalars='normalized_stress', cmap='coolwarm_r', scalar_bar_args={'title': 'Difference'})
    pl.add_text('Difference', font_size=10)
    

    pl.link_views()
    pl.show()

# Load two versions
original = load_and_process_mesh('data/beam_stress.vtu')
modified = load_and_process_mesh('data/beam_stress.vtu')

# Modify one mesh (simulate design change)
modified['normalized_stress'] = modified['normalized_stress'] * 1.2  # 20% increase

# Compare
visualize_comparison(original, modified)

